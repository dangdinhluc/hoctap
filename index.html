<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --sidebar-width: 280px;
        }

        body {
            background-color: #f8f9fa;
            overflow-x: hidden;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            background-color: #fff;
            border-right: 1px solid #dee2e6;
            padding: 1rem;
            z-index: 1045;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }

        .main-content {
            padding: 1.5rem;
            transition: margin-left 0.3s ease-in-out;
        }

        .mobile-header {
            display: none;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 1030;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        @media (max-width: 991.98px) {
            .mobile-header {
                display: flex;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            body.sidebar-show .sidebar {
                transform: translateX(0);
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            }

            body.sidebar-show .sidebar-overlay {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1020;
        }

        #chat-output {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f1f3f5;
            padding: 1rem;
        }

        .flashcard {
            perspective: 1000px;
            cursor: pointer;
            height: 220px;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flashcard.is-flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            border-radius: .375rem;
            box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075);
        }

        .flashcard-front {
            background-color: #fff;
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background-color: var(--bs-primary);
            color: #fff;
        }

        .toast-container {
            z-index: 1100;
        }

        .list-group-item.correct {
            background-color: #d1e7dd !important;
            border-color: #badbcc !important;
        }

        .list-group-item.incorrect {
            background-color: #f8d7da !important;
            border-color: #f5c2c7 !important;
            text-decoration: line-through;
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <header class="mobile-header p-2 align-items-center justify-content-between">
        <h5 class="mb-0 ms-2">✨Gino1 Thực Phẩm</h5>
        <button class="btn btn-light" type="button" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4"></i>
        </button>
    </header>
    <div class="sidebar d-flex flex-column">
        <h4 class="mb-4">✨Gino1 Thực Phẩm</h4>
        <button id="podcast-toggle-btn" class="btn btn-primary w-100 mb-4" onclick="togglePodcast()">
            <i id="podcast-icon" class="bi bi-headphones me-2"></i>
            <span id="podcast-text">Nghe Podcast</span>
        </button>

        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button class="nav-link text-start active" onclick="loadView('welcome', this)">
                <i class="bi bi-info-circle-fill me-2"></i>Hướng dẫn
            </button>
            <button class="nav-link text-start" onclick="loadView('documents', this)">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>Tài liệu học
            </button>
            <button class="nav-link text-start" onclick="loadView('vocab', this)">
                <i class="bi bi-card-text me-2"></i>Học Từ vựng
            </button>
            <button class="nav-link text-start" onclick="loadView('exercise', this)">
                <i class="bi bi-pencil-square me-2"></i>Bài tập & Thi thử
            </button>
            <button class="nav-link text-start" onclick="loadView('huongDanChung', this)">
                <i class="bi bi-compass-fill me-2"></i>Hướng dẫn chung
            </button>
        </div>
    </div>
    <main class="main-content">
        <div class="container-fluid" id="content-display"></div>
    </main>
    <div class="fab-container">
        <button class="btn btn-info btn-lg rounded-circle shadow-lg" type="button" data-bs-toggle="modal"
            data-bs-target="#ai-chat-modal" style="width: 60px; height: 60px;">
            <i class="bi bi-robot fs-4"></i>
        </button>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="app-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <audio id="background-podcast-player" style="display:none;"></audio>
    <div class="modal fade" id="ai-chat-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="height: 80vh;">
                <div class="modal-header text-white" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0);">
                    <h5 class="modal-title">Trợ lý AI - Thầy Lực</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column p-0">
                    <div id="chat-output"></div>
                    <div class="modal-footer mt-auto p-2">
                        <input type="text" class="form-control" id="chat-input"
                            placeholder="Nhập câu hỏi và nhấn Enter..." onkeydown="handleChat(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="context-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">✨ Phân tích từ vựng bằng AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="context-modal-body"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        const contentDisplay = document.getElementById('content-display');
        let chatHistory = [];
        let contextModalInstance = null;
        let webAppUrl = '';
        let appToastInstance = null;
        let podcastPlayer = document.getElementById('background-podcast-player');
        let isPodcastLoading = false;
        let podcastBlobUrl = null;
        let allQuizQuestions = [];
        let currentQuiz = [];
        let quizSubmitted = false;

        // --- CÁC HÀM TIỆN ÍCH & ĐIỀU HƯỚNG ---
        function toggleSidebar() { document.body.classList.toggle('sidebar-show'); }
        const btoaUtf8 = str => window.btoa(unescape(encodeURIComponent(str)));
        const escapeHTML = str => {
            if (!str) return '';
            return str.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
        }

        function showToast(message) {
            if (!appToastInstance) { appToastInstance = new bootstrap.Toast(document.getElementById('app-toast')); }
            document.querySelector('#app-toast .toast-body').textContent = message;
            appToastInstance.show();
        }

        function handleServerResponse(result, displayFunction, element = null) {
            if (result.error) {
                const errorHtml = `<div class="alert alert-danger"><strong>Lỗi:</strong> ${result.error}</div>`;
                if (element) element.innerHTML = errorHtml;
                else contentDisplay.innerHTML = errorHtml;
            } else if (result.data !== undefined) {
                displayFunction(result.data, element);
            } else {
                const errorHtml = `<div class="alert alert-warning"><strong>Lỗi không xác định.</strong></div>`;
                if (element) element.innerHTML = errorHtml;
                else contentDisplay.innerHTML = errorHtml;
            }
        }

        // =======================================================
        // ===       ĐÃ SỬA: Thêm view 'huongDanChung'         ===
        // =======================================================
        function loadView(viewId, element) {
            if (window.innerWidth < 992) { toggleSidebar(); }
            document.querySelectorAll('#v-pills-tab .nav-link').forEach(li => li.classList.remove('active'));
            if (element) element.classList.add('active');
            contentDisplay.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="height: 80vh;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

            const viewMap = {
                'welcome': displayWelcomeMessage,
                'documents': () => google.script.run.withSuccessHandler(r => handleServerResponse(r, displayPdfViewer)).getPdfDocuments(),
                'vocab': () => google.script.run.withSuccessHandler(r => handleServerResponse(r, displayVocabularySection)).getVocabularyList(),
                'exercise': () => displayQuizInterface(),
                'huongDanChung': () => google.script.run.withSuccessHandler(r => handleServerResponse(r, displayHuongDanChung)).getHuongDanChung()
            };
            (viewMap[viewId] || displayWelcomeMessage)();
        }

        // --- CÁC HÀM HIỂN THỊ ---
        function displayWelcomeMessage() {
            contentDisplay.innerHTML = `
                <div class="p-4 bg-white rounded-3 shadow-sm">
                    <h1 class="display-6 fw-bold">Chào mừng bạn!</h1>
                    <p class="fs-5">Đây là không gian học tập thông minh, được tối ưu hóa để giúp bạn chinh phục kỳ thi một cách hiệu quả nhất.</p>
                    <hr>
                    <h4 class="mt-4">Hướng dẫn sử dụng các tính năng</h4>
                    <div class="list-group">
                      <div class="list-group-item"><h5 class="mb-1"><i class="bi bi-headphones text-primary me-2"></i>Nghe Podcast chạy nền</h5><p class="mb-1">Nhấn nút <strong>"Nghe Podcast"</strong> ở menu bên trái để bắt đầu phát bài ôn tập. Nhấn một lần nữa để tạm dừng. Tính năng này hoạt động ngay cả khi bạn chuyển qua các mục khác.</p></div>
                      <div class="list-group-item"><h5 class="mb-1"><i class="bi bi-robot text-info me-2"></i>Trợ lý AI - Thầy Lực</h5><p class="mb-1">Nhấn vào biểu tượng <strong>robot màu xanh</strong> ở góc dưới bên phải để mở cửa sổ chat. Bạn có thể hỏi bất cứ điều gì liên quan đến tài liệu học.</p></div>
                      <div class="list-group-item"><h5 class="mb-1"><i class="bi bi-stars text-success me-2"></i>Các tính năng AI thông minh</h5><p class="mb-1">Hãy tìm các biểu tượng <strong>✨</strong> trong ứng dụng! Ví dụ, trong mục <strong>Học Từ vựng</strong>, nhấn vào ✨ để AI tạo câu ví dụ. Trong mục <strong>Bài tập</strong>, nhấn nút "Tạo bài với AI" để hệ thống tạo một bộ đề mới kết hợp câu hỏi có sẵn và câu hỏi từ AI.</p></div>
                    </div>
                </div>`;
        }

        // =======================================================
        // === ĐÃ THÊM: Hàm hiển thị nội dung Hướng dẫn chung   ===
        // =======================================================
        function displayHuongDanChung(data) {
            if (!data || data.length === 0) {
                contentDisplay.innerHTML = '<h2>Hướng dẫn chung</h2><div class="alert alert-info mt-3">Hiện chưa có nội dung hướng dẫn. Vui lòng thêm dữ liệu vào trang tính "HuongDanChung".</div>';
                return;
            }

            const accordionId = "huongDanAccordion";
            let accordionHtml = data.map((item, index) => {
                const itemId = `item-${index}`;
                // Dùng marked.parse để render nội dung từ Markdown
                const itemContent = item.NoiDung || '<p>Chưa có nội dung chi tiết.</p>';
                return `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-${itemId}">
                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${itemId}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse-${itemId}">
                            <strong>${item.TieuDe || 'Không có tiêu đề'}</strong>
                        </button>
                    </h2>
                    <div id="collapse-${itemId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${itemId}" data-bs-parent="#${accordionId}">
                        <div class="accordion-body">
                            ${itemContent}
                        </div>
                    </div>
                </div>`;
            }).join('');

            contentDisplay.innerHTML = `
                <h2 class="mb-3">Hướng dẫn chung</h2>
                <div class="accordion" id="${accordionId}">
                    ${accordionHtml}
                </div>`;
        }

        function displayPdfViewer(data) {
            const getEmbeddableUrl = url => url && url.includes('drive.google.com/file/d/') ? url.replace('/view?usp=sharing', '/preview').replace('/view', '/preview') : url;
            if (!data || data.length === 0) { contentDisplay.innerHTML = '<h4>Tài liệu học</h4><div class="alert alert-info">Chưa có dữ liệu tại sheet "TaiLieuPDF".</div>'; return; }
            let vietLink = '', japanLink = '';
            data.forEach(item => {
                const name = (item["Tên tài liệu"] || '').toLowerCase();
                if (name.includes('việt')) vietLink = getEmbeddableUrl(item.Link);
                if (name.includes('nhật')) japanLink = getEmbeddableUrl(item.Link);
            });
            if (!vietLink && !japanLink) { contentDisplay.innerHTML = '<h4>Tài liệu học</h4><div class="alert alert-warning">Không tìm thấy link tài liệu hợp lệ trong sheet "TaiLieuPDF".</div>'; return; }

            const vietTabActive = vietLink ? 'active' : '';
            const japanTabActive = !vietLink && japanLink ? 'active' : '';
            const initialSrc = vietLink || japanLink;

            const safeVietLink = escapeHTML(vietLink || '');
            const safeJapanLink = escapeHTML(japanLink || '');

            const tabsHtml = `<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link ${vietTabActive}" href="#" onclick="switchPdfTab(this, '${safeVietLink}', event)">Tài liệu Tiếng Việt</a></li><li class="nav-item"><a class="nav-link ${japanTabActive}" href="#" onclick="switchPdfTab(this, '${safeJapanLink}', event)">Tài liệu Tiếng Nhật</a></li></ul>`;
            const iframeHtml = `<div class="w-100" style="height: 80vh;"><iframe id="pdf-iframe" class="w-100 h-100 border" src="${initialSrc}"></iframe></div>`;
            contentDisplay.innerHTML = tabsHtml + iframeHtml;
        }


        function switchPdfTab(el, url, e) {
            e.preventDefault();
            if (!url || url === 'null' || url === 'undefined') {
                alert('Không có link tài liệu cho mục này.');
                return;
            }
            document.querySelectorAll('.nav-tabs .nav-link').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('pdf-iframe').src = url;
        }

        function displayVocabularySection(data) {
            if (!data || data.length === 0) {
                contentDisplay.innerHTML = '<h4>Học Từ vựng</h4><div class="alert alert-info">Chưa có dữ liệu từ vựng.</div>';
                return;
            }
            contentDisplay.innerHTML = `<h2>Học Từ vựng</h2>
                <ul class="nav nav-tabs mb-3" id="vocab-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab">Danh sách</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="flashcard-tab" data-bs-toggle="tab" data-bs-target="#flashcard-pane" type="button" role="tab">Flashcard</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="list-pane" role="tabpanel">${generateVocabListHtml(data)}</div>
                    <div class="tab-pane fade" id="flashcard-pane" role="tabpanel">${generateFlashcardsHtml(data)}</div>
                </div>`;
        }

        const shuffleArray = array => { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; };

        function generateFlashcardsHtml(data) {
            const shuffledData = shuffleArray([...data]);
            let cards = shuffledData.map((item) => {
                const safeJP = escapeHTML(item.JP || '');
                return `
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                        <div class="flashcard-inner">
                            <div class="flashcard-front card card-body">
                                <h4 class="card-title">${item.JP || ''}</h4>
                                <button class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2" onclick="speak('${safeJP}', event)" title="Phát âm"><i class="bi bi-volume-up-fill"></i></button>
                            </div>
                            <div class="flashcard-back card card-body bg-primary text-white">
                                <h4 class="card-title">${item.VN || ''}</h4>
                            </div>
                        </div>
                    </div>
                </div>`
            }).join('');
            return `<p class="text-muted">Nhấp vào thẻ để lật. Các thẻ được xáo trộn ngẫu nhiên.</p><div class="row g-3">${cards}</div>`;
        }

        function generateVocabListHtml(data) {
            let rows = data.map((item, index) => {
                const safeJP = escapeHTML(item.JP || '');
                return `
                <tr>
                    <th scope="row">${index + 1}</th>
                    <td>${item.JP || ''}</td>
                    <td>${item.VN || ''}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary py-0 px-2" onclick="speak('${safeJP}')" title="Phát âm"><i class="bi bi-volume-up-fill"></i></button>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info py-0 px-2" onclick="showVocabContext(this, '${safeJP}')" title="Xem ví dụ với AI">✨</button>
                    </td>
                </tr>`
            }).join('');
            return `<div class="table-responsive"><table class="table table-striped table-hover align-middle">
                        <thead><tr><th>#</th><th>Tiếng Nhật</th><th>Tiếng Việt</th><th class="text-center">Âm thanh</th><th class="text-center">Ví dụ AI</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table></div>`;
        }

        function speak(text, event) {
            if (event) {
                event.stopPropagation();
            }
            if (!text || typeof window.speechSynthesis === 'undefined') {
                showToast('Trình duyệt của bạn không hỗ trợ tính năng này.');
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        }

        function showVocabContext(btn, word) {
            if (!contextModalInstance) {
                contextModalInstance = new bootstrap.Modal(document.getElementById('context-modal'));
            }
            const modalBody = document.getElementById('context-modal-body');
            modalBody.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            contextModalInstance.show();
            btn.disabled = true;
            google.script.run
                .withSuccessHandler(result => {
                    handleServerResponse(result, (data, el) => { el.innerHTML = marked.parse(data); }, modalBody);
                    btn.disabled = false;
                })
                .withFailureHandler(err => {
                    modalBody.innerHTML = `<div class="alert alert-danger">Lỗi: ${err.message}</div>`;
                    btn.disabled = false;
                })
                .getVocabContext(word);
        }

        function displayQuizInterface() {
            quizSubmitted = false;
            contentDisplay.innerHTML = `
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                    <h2 class="mb-0">Bài tập & Thi thử</h2>
                    <div id="quiz-score" class="fs-4 fw-bold text-primary"></div>
                </div>
                <div class="d-flex flex-wrap gap-2 mb-4 border-bottom pb-3">
                    <button id="new-quiz-btn" class="btn btn-primary" onclick="startNewQuiz()"><i class="bi bi-arrow-repeat"></i> Làm bài mới</button>
                    <button id="submit-quiz-btn" class="btn btn-success" onclick="submitQuiz()"><i class="bi bi-check2-circle"></i> Nộp bài</button>
                    <button id="ai-quiz-btn" class="btn btn-info" onclick="generateAiQuiz(this)"><i class="bi bi-stars"></i> Tạo bài với AI</button>
                </div>
                <div id="quiz-container">
                    <div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
            `;
            if (allQuizQuestions.length === 0) {
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.data) {
                            allQuizQuestions = result.data;
                            startNewQuiz();
                        } else {
                            handleServerResponse(result, () => { }, document.getElementById('quiz-container'));
                        }
                    })
                    .withFailureHandler(err => {
                        document.getElementById('quiz-container').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
                    })
                    .getQuizQuestions();
            } else {
                startNewQuiz();
            }
        }

        function startNewQuiz(questions = null) {
            quizSubmitted = false;
            document.getElementById('submit-quiz-btn').disabled = false;
            document.getElementById('quiz-score').innerHTML = '';

            if (questions) {
                currentQuiz = questions.map(q => ({ ...q, id: q.id || btoaUtf8(q.question) }));
            } else {
                currentQuiz = shuffleArray([...allQuizQuestions]).slice(0, 20);
            }
            renderQuizForm(currentQuiz);
        }

        function renderQuizForm(questions) {
            const container = document.getElementById('quiz-container');
            if (!questions || questions.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Không có câu hỏi nào để hiển thị.</div>';
                return;
            }
            let html = '';
            questions.forEach((q, index) => {
                const optionsHtml = shuffleArray([...q.options]).map(opt => `
                    <li class="list-group-item">
                        <input class="form-check-input me-2" type="radio" name="q_${q.id}" id="${q.id}_${btoaUtf8(opt)}" value="${escapeHTML(opt)}">
                        <label class="form-check-label stretched-link" for="${q.id}_${btoaUtf8(opt)}">${opt}</label>
                    </li>
                `).join('');

                html += `
                    <div class="card mb-3" id="card-${q.id}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>Câu ${index + 1}:</strong>
                            <button class="btn btn-sm btn-outline-info py-0 px-2"
                                    onclick="askAiAboutQuestion(this)"
                                    data-question="${escapeHTML(q.question)}"
                                    data-options='${escapeHTML(JSON.stringify(q.options))}'
                                    title="Hỏi AI về câu này">
                                <i class="bi bi-robot"></i> Hỏi AI
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${q.question}</p>
                            <ul class="list-group">${optionsHtml}</ul>
                            <div class="mt-3 alert alert-info d-none" id="exp-${q.id}">
                                <strong>Giải thích:</strong> ${q.explanation}
                            </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function submitQuiz() {
            if (quizSubmitted) return;
            let score = 0;
            currentQuiz.forEach((q) => {
                const selectedOption = document.querySelector(`input[name="q_${q.id}"]:checked`);
                const optionsContainer = document.getElementById(`card-${q.id}`).querySelector('.list-group');

                optionsContainer.querySelectorAll('li').forEach(li => {
                    const input = li.querySelector('input');
                    input.disabled = true;
                    if (input.value === escapeHTML(q.answer)) {
                        li.classList.add('correct');
                    }
                });

                if (selectedOption) {
                    if (selectedOption.value === escapeHTML(q.answer)) {
                        score++;
                    } else {
                        selectedOption.parentElement.classList.add('incorrect');
                    }
                }
                document.getElementById(`exp-${q.id}`).classList.remove('d-none');
            });
            quizSubmitted = true;
            document.getElementById('submit-quiz-btn').disabled = true;
            document.getElementById('quiz-score').innerHTML = `Điểm của bạn: <span class="badge bg-primary rounded-pill fs-4">${score} / ${currentQuiz.length}</span>`;
            contentDisplay.scrollIntoView({ behavior: 'smooth' });
        }

        function generateAiQuiz(btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang tạo...';
            google.script.run
                .withSuccessHandler(result => {
                    if (result.error) {
                        showToast("Lỗi tạo câu hỏi từ AI: " + result.error);
                    } else if (result.data) {
                        startNewQuiz(result.data);
                    }
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-stars"></i> Tạo bài với AI';
                })
                .withFailureHandler(err => {
                    showToast("Lỗi hệ thống: " + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-stars"></i> Tạo bài với AI';
                })
                .generateQuizFromDocs();
        }

        function base64ToBlob(base64, contentType = '', sliceSize = 512) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: contentType });
        }
        function togglePodcast() {
            if (isPodcastLoading) {
                showToast("Đang tải file podcast, vui lòng đợi...");
                return;
            }
            if (podcastBlobUrl && !podcastPlayer.paused) {
                podcastPlayer.pause();
                return;
            }
            if (podcastBlobUrl && podcastPlayer.paused) {
                podcastPlayer.play();
                return;
            }
            const podcastBtn = document.getElementById('podcast-toggle-btn');
            const podcastIcon = document.getElementById('podcast-icon');
            const podcastText = document.getElementById('podcast-text');
            isPodcastLoading = true;
            podcastIcon.className = "spinner-border spinner-border-sm me-2";
            podcastText.textContent = "Đang tải...";
            podcastBtn.disabled = true;

            google.script.run
                .withSuccessHandler(result => {
                    if (result.error) {
                        showToast("Lỗi: " + result.error);
                        resetPodcastButton();
                        return;
                    }
                    if (result.data && result.data.base64Data) {
                        const blob = base64ToBlob(result.data.base64Data, result.data.contentType);
                        podcastBlobUrl = URL.createObjectURL(blob);
                        podcastPlayer.src = podcastBlobUrl;
                        podcastPlayer.play();
                        showToast("Bắt đầu phát podcast.");
                    } else {
                        showToast("Không nhận được dữ liệu podcast hợp lệ.");
                        resetPodcastButton();
                    }
                })
                .withFailureHandler(err => {
                    showToast("Lỗi hệ thống khi tải podcast: " + err.message);
                    resetPodcastButton();
                })
                .getPodcastAudioData();
        }

        podcastPlayer.onplay = function () {
            const podcastIcon = document.getElementById('podcast-icon');
            const podcastText = document.getElementById('podcast-text');
            podcastIcon.className = "bi bi-pause-circle-fill me-2";
            podcastText.textContent = "Tạm dừng";
            isPodcastLoading = false;
            document.getElementById('podcast-toggle-btn').disabled = false;
        };

        podcastPlayer.onpause = function () {
            const podcastIcon = document.getElementById('podcast-icon');
            const podcastText = document.getElementById('podcast-text');
            podcastIcon.className = "bi bi-play-circle-fill me-2";
            podcastText.textContent = "Phát tiếp";
            isPodcastLoading = false;
            document.getElementById('podcast-toggle-btn').disabled = false;
        };

        function resetPodcastButton() {
            const podcastBtn = document.getElementById('podcast-toggle-btn');
            const podcastIcon = document.getElementById('podcast-icon');
            const podcastText = document.getElementById('podcast-text');
            isPodcastLoading = false;
            podcastIcon.className = "bi bi-headphones me-2";
            podcastText.textContent = "Nghe Podcast";
            podcastBtn.disabled = false;
        }

        const aiChatModal = document.getElementById('ai-chat-modal');
        aiChatModal.addEventListener('show.bs.modal', () => {
            if (chatHistory.length === 0) {
                const chatOutput = document.getElementById('chat-output');
                chatOutput.innerHTML = `
<div class="d-flex align-items-start gap-3 mb-4">
  <div class="flex-grow-1">
    <div class="bg-light border rounded p-3 shadow-sm">
      <p class="fw-bold mb-2 text-primary">Chào bạn! Tôi là trợ lý AI - <span class="text-success">Lực Sensei</span>.</p>
      <p class="mb-2">Tôi luôn sẵn sàng giúp bạn học tập hiệu quả hơn. Bạn có thể yêu cầu tôi giải thích, đưa ra ví dụ, hoặc tạo bài tập. Thử các gợi ý sau:</p>
      <ul class="list-unstyled ps-3 mb-2">
        <li class="mb-1"><i class="bi bi-lightbulb text-warning"></i> <small><strong>"Trình bày về 5S."</strong></small></li>
        <li class="mb-1"><i class="bi bi-search text-info"></i> <small><strong>"ヒヤリ・ハット là gì?"</strong></small></li>
        <li class="mb-1"><i class="bi bi-shield-check text-success"></i> <small><strong>"Giải thích về an toàn vệ sinh thực phẩm."</strong></small></li>
        <li class="mb-1"><i class="bi bi-pencil-square text-primary"></i> <small><strong>"Cho tôi bài tập về quy trình sản xuất."</strong></small></li>
        <li><i class="bi bi-question-circle text-danger"></i> <small><strong>"Hãy đưa ra một câu hỏi trắc nghiệm để luyện tập."</strong></small></li>
      </ul>
    </div>
  </div>
</div>

              `;
            }
        });

        // --- CÁC HÀM XỬ LÝ CHAT VỚI AI ---

        function scrollToChatBottom() {
            const chatOutput = document.getElementById('chat-output');
            setTimeout(() => {
                chatOutput.scrollTop = chatOutput.scrollHeight;
            }, 0);
        }

        function sendToAiAndDisplay(query) {
            if (!query) return;

            const chatOutput = document.getElementById('chat-output');
            chatHistory.push({ role: "user", parts: [{ text: query }] });
            chatOutput.insertAdjacentHTML('beforeend', `<div class="d-flex justify-content-end mb-3"><div class="bg-primary text-white p-2 px-3 rounded" style="max-width: 80%; white-space: pre-wrap;">${escapeHTML(query)}</div></div>`);
            scrollToChatBottom();

            const loaderId = `loader-${Date.now()}`;
            chatOutput.insertAdjacentHTML('beforeend', `<div id="${loaderId}" class="d-flex mb-3"><div class="flex-shrink-0" style="width:40px; height:40px;"><div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center h-100"><i class="bi bi-robot text-white fs-5"></i></div></div><div class="ms-2"><div class="bg-light p-2 px-3 rounded ai-message-content" style="min-width: 60px;"><div class="spinner-border spinner-border-sm"></div></div></div></div>`);
            scrollToChatBottom();

            google.script.run
                .withSuccessHandler(result => {
                    const loaderDiv = document.getElementById(loaderId);
                    if (!loaderDiv) return;
                    const contentDiv = loaderDiv.querySelector('.ai-message-content');
                    if (result.error) {
                        contentDiv.innerHTML = `<strong class="text-danger">Lỗi:</strong> ${result.error}`;
                    } else {
                        const markdownResponse = result.data;
                        contentDiv.innerHTML = marked.parse(markdownResponse);
                        chatHistory.push({ role: "model", parts: [{ text: markdownResponse }] });
                    }
                    scrollToChatBottom();
                })
                .withFailureHandler(error => {
                    const loaderDiv = document.getElementById(loaderId);
                    if (!loaderDiv) return;
                    const contentDiv = loaderDiv.querySelector('.ai-message-content');
                    contentDiv.innerHTML = `<strong class="text-danger">Lỗi Hệ Thống:</strong> ${error.message}`;
                    scrollToChatBottom();
                })
                .askGemini(chatHistory);
        }

        function handleChat(event) {
            if (event.key !== 'Enter') return;
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            sendToAiAndDisplay(query);

            input.value = '';
            input.focus();
        }

        function askAiAboutQuestion(buttonElement) {
            const question = buttonElement.dataset.question;
            const optionsString = buttonElement.dataset.options;

            if (!question || !optionsString) return;

            const chatModalEl = document.getElementById('ai-chat-modal');
            const chatModalInstance = bootstrap.Modal.getOrCreateInstance(chatModalEl);
            chatModalInstance.show();

            try {
                const options = JSON.parse(optionsString);
                let prompt = `Hãy giải thích và phân tích câu hỏi trắc nghiệm này giúp tôi:\n\nCâu hỏi: "${question}"\n\nCác lựa chọn:\n`;
                options.forEach((opt, index) => {
                    prompt += `- ${String.fromCharCode(65 + index)}: ${opt}\n`;
                });
                sendToAiAndDisplay(prompt);
            } catch (e) {
                console.error("Lỗi khi xử lý dữ liệu câu hỏi:", e);
                showToast("Đã có lỗi xảy ra khi lấy dữ liệu câu hỏi.");
            }
        }

        // --- KHỞI ĐỘNG ỨNG DỤNG ---
        function startApp() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
                setTimeout(startApp, 100);
            } else {
                loadView('welcome', document.querySelector('#v-pills-tab .nav-link.active'));
            }
        }

        window.addEventListener('load', startApp);

    </script>
</body>

</html>